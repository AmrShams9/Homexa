<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Arial', sans-serif; }
    .form-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .logo { width: 80px; display: block; margin: 10px auto; }
    .container { max-width: 800px; margin: auto; }
    #services-container { margin-top: 20px; }
    table { width: 100%; margin-top: 10px; }
    th, td { text-align: center; padding: 8px; }
    .btn-danger { margin-top: 5px; }
  </style>
</head>

<body>
<div class="container">
  <img src="/Artboard 5@5x.png" alt="logo" class="logo">
  <div class="form-container">
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
    <form id="editTaskForm">

      <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <div class="mb-3">
        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input type="text" class="form-control" name="customerName" value="<%= task.customerName %>" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" class="form-control" name="customerPhone" value="<%= task.customerPhone %>" required>
      </div>

      <!-- Ø®Ø±ÙŠØ·Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
      <div id="map" style="height: 300px; width: 100%; margin-bottom: 15px;"></div>
      <input type="hidden" id="customerLat" name="customerLat" value="<%= task.customerLat %>">
      <input type="hidden" id="customerLng" name="customerLng" value="<%= task.customerLng %>">
      <input type="hidden" id="customerLocation" name="customerLocation">
        
        

      <!-- Ø§Ù„Ø®Ø¯Ù…Ø§Øª -->
      <h2>Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h2>
      <div id="services-container">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
              <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="servicesBody"></tbody>
        </table>
        <button type="button" class="btn btn-success" onclick="addServiceRow()">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø£Ø®Ø±Ù‰</button>
      </div>

      <!-- ÙˆÙ‚Øª Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ§Ù„Ø¯ÙØ¹ -->
      <div class="mb-3 mt-3">
        <label class="form-label">ÙˆÙ‚Øª Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <input type="text" class="form-control" name="serviceTime" value="<%= task.serviceTime %>" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select class="form-select" name="paymentMethod" required>
          <option value="">Ø§Ø®ØªØ±</option>
          <option value="Ø¯ÙØ¹ Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶" <%= task.paymentMethod === 'Ø¯ÙØ¹ Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶' ? 'selected' : '' %>>Ø¯ÙØ¹ Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶</option>
          <option value="Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ¨" <%= task.paymentMethod === 'Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ¨' ? 'selected' : '' %>>Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ¨</option>
        </select>
      </div>

      <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
      <div class="mb-3">
        <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select class="form-select" name="status" required>
          <option value="Assigned" <%= task.status === 'Assigned' ? 'selected' : '' %>>Assigned</option>
          <option value="InProgress" <%= task.status === 'InProgress' ? 'selected' : '' %>>In Progress</option>
          <option value="On Hold" <%= task.status === 'On Hold' ? 'selected' : '' %>>On Hold</option>
          <option value="completed" <%= task.status === 'completed' ? 'selected' : '' %>>Completed</option>
          <option value="canceled" <%= task.status === 'canceled' ? 'selected' : '' %>>Canceled</option>
          <option value="New" <%= task.status === 'New' ? 'selected' : '' %>>New</option>
        </select>
      </div>

      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø± -->
      <div class="mb-3">
        <h5>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©: <span id="baseTotal">0</span> SAR</h5>
        <h5>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (15%): <span id="vatAmount">0</span> SAR</h5>
        <h5><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="totalPrice">0</span> SAR</strong></h5>
        <input type="hidden" name="totalPrice" id="hiddenTotalPrice" value="0">
      </div>

      <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
      <button type="submit" class="btn btn-primary w-100">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>

    </form>
  </div>
</div>

<!-- Ø³ÙƒØ±ÙŠØ¨Øª -->
<script>
const allServices = <%- JSON.stringify(allServices || []) %>;
const selectedServiceIds = <%- JSON.stringify(selectedServiceIds || []) %>;
const serviceQuantities = <%- JSON.stringify(serviceQuantities || {}) %>;

function createServiceOptions(category) {
  return allServices.filter(s => s.category === category)
    .map(s => `<option value="${s.id}" data-price="${s.price}">${s.name}</option>`).join('');
}

function addServiceRow(selected = {}) {
  const tbody = document.getElementById("servicesBody");
  const row = document.createElement("tr");

  const categories = [...new Set(allServices.map(s => s.category))];
  const selectedCategory = selected.category || categories[0];

  row.innerHTML = `
    <td><select class="form-control category-select">${categories.map(c => `<option value="${c}" ${c === selectedCategory ? 'selected' : ''}>${c}</option>`)}</select></td>
    <td><select class="form-control service-select"></select></td>
    <td><span class="unit-price">0</span> SAR</td>
    <td><input type="number" class="form-control qty-input" value="${selected.quantity || 1}" min="1"></td>
    <td><span class="line-total">0</span> SAR</td>
    <td><button type="button" class="btn btn-danger" onclick="this.closest('tr').remove(); calculateOrderTotals();">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
  `;
  tbody.appendChild(row);

  const categorySelect = row.querySelector(".category-select");
  const serviceSelect = row.querySelector(".service-select");
  const qtyInput = row.querySelector(".qty-input");

  function updateServiceOptions() {
    serviceSelect.innerHTML = createServiceOptions(categorySelect.value);
    updateRowPrices();
  }

  function updateRowPrices() {
    const price = parseFloat(serviceSelect.selectedOptions[0]?.dataset.price || 0);
    const qty = parseInt(qtyInput.value) || 1;
    row.querySelector(".unit-price").innerText = price.toFixed(2);
    row.querySelector(".line-total").innerText = (price * qty).toFixed(2);
    calculateOrderTotals();
  }

  categorySelect.addEventListener("change", updateServiceOptions);
  serviceSelect.addEventListener("change", updateRowPrices);
  qtyInput.addEventListener("input", updateRowPrices);

  updateServiceOptions();

  if (selected.serviceId) {
    serviceSelect.value = selected.serviceId;
    updateRowPrices();
  }
}

function calculateOrderTotals() {
  let baseTotal = 0;
  document.querySelectorAll('#servicesBody tr').forEach(row => {
    const lineTotal = parseFloat(row.querySelector('.line-total').innerText) || 0;
    baseTotal += lineTotal;
  });
  const vat = baseTotal * 0.15;
  const total = baseTotal + vat;
  document.getElementById('baseTotal').innerText = baseTotal.toFixed(2);
  document.getElementById('vatAmount').innerText = vat.toFixed(2);
  document.getElementById('totalPrice').innerText = total.toFixed(2);
  document.getElementById('hiddenTotalPrice').value = total.toFixed(2);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
window.onload = () => {
  if (selectedServiceIds.length > 0) {
    selectedServiceIds.forEach(id => {
      const service = allServices.find(s => s.id === id);
      if (service) {
        addServiceRow({
          category: service.category,
          serviceId: service.id,
          quantity: serviceQuantities[service.id] || 1
        });
      }
    });
  } else {
    addServiceRow();
  }
  calculateOrderTotals();
};

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
document.getElementById("editTaskForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = new FormData(this);

  const services = [];
  document.querySelectorAll('#servicesBody tr').forEach(row => {
    const serviceId = parseInt(row.querySelector('.service-select').value);
    const quantity = parseInt(row.querySelector('.qty-input').value) || 1;
    services.push({ id: serviceId, quantity });
  });

  const payload = {
    customerPhone: form.get("customerPhone"),
    customerName: form.get("customerName"),
    customerLat: parseFloat(form.get("customerLat")),
    customerLng: parseFloat(form.get("customerLng")),
    serviceTime: form.get("serviceTime"),
    paymentMethod: form.get("paymentMethod"),
    status: form.get("status"),
    totalPrice: parseFloat(document.getElementById('hiddenTotalPrice').value),
    services: services
  };

  try {
    const response = await fetch(`/edit_task/<%= task.id %>`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    if (response.ok && result.success) {
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
      window.location.href = "/admin_dashboard";
    } else {
      alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (result.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    }
  } catch (err) {
    console.error(err);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  }
});
</script>
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFZcWUfcnxoAlGVGf7X7b4pE2IxbHDYzw&libraries=places"></script>

<script>
let map, marker, geocoder, searchBox;

function initMap() {
    const initialPosition = {
        lat: parseFloat(document.getElementById('customerLat').value) || 24.7136,
        lng: parseFloat(document.getElementById('customerLng').value) || 46.6753
    };
    map = new google.maps.Map(document.getElementById('map'), {
        center: initialPosition,
        zoom: 10
    });

    geocoder = new google.maps.Geocoder();
    placeMarker(initialPosition);

    map.addListener('click', function(event) {
        placeMarker(event.latLng);
    });

    const input = document.createElement("input");
    input.setAttribute("id", "map-search");
    input.setAttribute("type", "text");
    input.setAttribute("placeholder", "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹");
    input.classList.add("form-control");
    input.style.marginBottom = "10px";
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

    searchBox = new google.maps.places.SearchBox(input);

    map.addListener('bounds_changed', function() {
        searchBox.setBounds(map.getBounds());
    });

    searchBox.addListener('places_changed', function() {
        const places = searchBox.getPlaces();
        if (places.length === 0) return;
        const place = places[0];
        if (!place.geometry) return;
        placeMarker(place.geometry.location);
        map.panTo(place.geometry.location);
    });
}

function placeMarker(location) {
    if (marker) marker.setMap(null);

    marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true
    });

    updateLocationFields(location);

    marker.addListener('dragend', function() {
        updateLocationFields(marker.getPosition());
    });
}

function updateLocationFields(location) {
    document.getElementById('customerLat').value = location.lat();
    document.getElementById('customerLng').value = location.lng();

    geocoder.geocode({ location: location }, function(results, status) {
        if (status === 'OK' && results[0]) {
            document.getElementById('customerLocation').value = results[0].formatted_address;
        } else {
            document.getElementById('customerLocation').value = `Lat: ${location.lat()}, Lng: ${location.lng()}`;
        }
    });
}

// âœ… ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ÙŠØ´ØªØºÙ„ Ù…Ø¹ ÙƒÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', () => {
    initMap();
});
</script>




</body>
</html>
